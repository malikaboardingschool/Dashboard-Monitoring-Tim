<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Monitoring Tim - Sekolah Boarding Internasional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .notification {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .skeleton-card {
            background-color: #f1f5f9;
            border-radius: 0.75rem;
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        /* Custom scrollbar for task lists */
        .task-list::-webkit-scrollbar {
            width: 5px;
        }
        .task-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .task-list::-webkit-scrollbar-thumb {
            background: #a5b4fc;
            border-radius: 10px;
        }
        .task-list::-webkit-scrollbar-thumb:hover {
            background: #818cf8;
        }
        .chart-card { transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .chart-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
        .floating-animation { animation: float 3s ease-in-out infinite; }
        @keyframes float { 0%, 100% { transform: translateY(0px); } 50% { transform: translateY(-10px); } }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Header -->
    <header class="bg-white shadow-md border-b-4 border-blue-600 sticky top-0 z-20">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 py-4">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="flex-1">
                    <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-gray-800">Dashboard Monitoring Tim</h1>
                    <p class="text-sm sm:text-base text-gray-600 mt-1">Malika Islamic Boarding School</p>
                </div>
                 <div class="flex items-center gap-3">
                    <div id="sheetsStatus" class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></div>
                    <span class="text-xs sm:text-sm text-gray-600" id="sheetsStatusText">Menghubungkan...</span>
                    <button onclick="fetchDashboardData(true)" class="bg-blue-50 hover:bg-blue-100 text-blue-600 p-2 rounded-full transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Dashboard -->
    <main class="max-w-screen-2xl mx-auto px-4 sm:px-6 py-6 sm:py-8">
        <!-- KARTU STATISTIK (VERSI SIMPLE) -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- Program List -->
            <div class="chart-card bg-gradient-to-br from-blue-700 to-indigo-900 rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-sm font-medium text-blue-200">Program List</p>
                        <p class="text-4xl font-bold text-white" id="approvedPrograms"><span class="skeleton-card w-12 h-8 inline-block"></span></p>
                    </div>
                </div>
                <div class="space-y-2 text-sm" id="programListContainer">
                    <div class="skeleton-card w-full h-5"></div>
                    <div class="skeleton-card w-full h-5"></div>
                    <div class="skeleton-card w-full h-5"></div>
                </div>
            </div>
            <!-- Pembayaran SPP -->
            <div class="chart-card bg-gradient-to-br from-red-500 to-rose-700 rounded-xl shadow-lg p-6">
                <p class="text-base font-medium text-red-200 mb-2">Pembayaran SPP</p>
                <div class="flex items-center justify-between gap-4">
                    <!-- Donut Chart -->
                    <div class="relative w-32 h-32 flex-shrink-0">
                        <svg class="w-full h-full transform -rotate-90">
                            <circle class="text-red-700" stroke-width="12" stroke="currentColor" fill="transparent" r="50" cx="50%" cy="50%"/>
                            <circle id="paymentCircle" class="text-red-400" stroke-width="12" stroke-linecap="round" stroke="currentColor" fill="transparent" r="50" cx="50%" cy="50%" style="stroke-dasharray: 314; stroke-dashoffset: 314; transition: stroke-dashoffset 1s ease-out;"/>
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center">
                            <span id="paidPercentageText" class="text-3xl font-bold text-white">...</span>
                        </div>
                    </div>
                    <!-- Stats Text -->
                    <div class="flex-grow">
                        <p class="text-4xl font-bold text-white" id="paidStudents"><span class="skeleton-card w-20 h-10 inline-block"></span></p>
                        <p class="text-sm text-red-200" id="totalStudentsText">dari ... santri</p>
                        <div class="space-y-1 mt-4 border-t border-red-600 pt-2">
                            <div class="flex justify-between text-sm"><span class="text-red-100">Lunas</span><span class="font-medium text-green-200" id="paidCount">...</span></div>
                            <div class="flex justify-between text-sm"><span class="text-red-100">Belum Bayar</span><span class="font-medium text-rose-200" id="unpaidCount">...</span></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Upcoming Events -->
            <div class="chart-card bg-gradient-to-br from-purple-50 to-violet-100 rounded-xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-base font-medium text-gray-700">Upcoming Events</p>
                        <p class="text-4xl font-bold text-purple-600" id="upcomingEvents"><span class="skeleton-card w-12 h-10 inline-block"></span></p>
                        <p class="text-sm text-gray-600">bulan ini</p>
                    </div>
                </div>
                <div class="space-y-2" id="eventListContainer"><div class="skeleton-card w-full h-5"></div><div class="skeleton-card w-full h-5"></div></div>
            </div>
        </div>
        
        <hr class="my-8 border-gray-300">

        <h2 class="text-2xl font-bold text-gray-800 mb-6">Monitoring Tugas Tim</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 2xl:grid-cols-4 gap-6" id="teamGrid">
            <!-- Skeleton Loader Cards -->
            <div class="skeleton-card h-[500px]"></div>
            <div class="skeleton-card h-[500px]"></div>
            <div class="skeleton-card h-[500px]"></div>
            <div class="skeleton-card h-[500px]"></div>
        </div>
    </main>

    <!-- Notification -->
    <div id="notification" class="fixed top-20 right-4 w-auto bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden notification z-50">
        <span id="notificationText"></span>
    </div>

    <script>
        // Google Sheets Configuration
        const googleSheetsConfig = {
            webAppUrl: 'https://script.google.com/macros/s/AKfycbzhufJSLDws8_3PUd5coQDi_pqSBFoQqzVWGE7ePPa-Ry_i5S57AXko0BfDfxOTzYq2Nw/exec',
        };

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            notificationText.textContent = message;
            notification.className = `fixed top-20 right-4 w-auto text-white px-6 py-3 rounded-lg shadow-lg notification z-50 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
            notification.classList.remove('hidden');
            setTimeout(() => notification.classList.add('hidden'), 3000);
        }

        async function fetchDashboardData(forceRefresh = false) {
            const statusIndicator = document.getElementById('sheetsStatus');
            const statusText = document.getElementById('sheetsStatusText');
            statusIndicator.className = 'w-3 h-3 bg-yellow-500 rounded-full animate-pulse';
            statusText.textContent = 'Memuat Data...';

            let url = googleSheetsConfig.webAppUrl;
            if (forceRefresh) {
                url += `?cache_bust=${new Date().getTime()}`;
            }

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                statusIndicator.className = 'w-3 h-3 bg-green-500 rounded-full';
                statusText.textContent = 'Terhubung';
                
                renderSummaryCards(data.summary);
                renderTeamCards(data.teams);
                if(forceRefresh) showNotification('Data berhasil dimuat ulang!', 'success');

            } catch (error) {
                console.error("Error fetching data:", error);
                statusIndicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                statusText.textContent = 'Gagal Terhubung';
                document.getElementById('teamGrid').innerHTML = `<p class="text-red-600 col-span-full">Gagal memuat data tim. Pastikan URL Apps Script benar dan sudah di-deploy ulang.</p>`;
            }
        }

        function renderSummaryCards(summary) {
            // Update Program List Card
            document.getElementById('approvedPrograms').textContent = summary.approvedPrograms;
            const programListContainer = document.getElementById('programListContainer');
            programListContainer.innerHTML = '';
            if (summary.programList && summary.programList.length > 0) {
                 summary.programList.forEach(prog => {
                    const progDiv = document.createElement('div');
                    progDiv.className = 'text-xs border-b border-blue-600 pb-2 mb-2';
                    progDiv.innerHTML = `
                        <div class="flex justify-between items-center">
                            <p class="font-bold text-white text-sm">${prog.nama}</p>
                            <span class="font-medium text-blue-100 bg-blue-500 px-2 py-0.5 rounded-full">${prog.status}</span>
                        </div>
                        <div class="flex justify-between text-blue-300 mt-1">
                            <span>${prog.kategori}</span>
                            <span>Oleh: ${prog.tim}</span>
                        </div>
                    `;
                    programListContainer.appendChild(progDiv);
                });
            } else {
                programListContainer.innerHTML = `<p class="text-xs text-blue-300 italic">Belum ada program yang disetujui.</p>`;
            }

            // Update SPP Card
            document.getElementById('paidStudents').textContent = summary.paidStudents;
            document.getElementById('totalStudentsText').innerHTML = `dari ${summary.totalStudents} santri`;
            document.getElementById('paidPercentageText').textContent = `${summary.paidPercentage}%`;
            document.getElementById('paidCount').textContent = summary.paidStudents;
            document.getElementById('unpaidCount').textContent = summary.unpaidCount;
            
            // Update Events Card
            const eventListContainer = document.getElementById('eventListContainer');
            eventListContainer.innerHTML = '';
            document.getElementById('upcomingEvents').textContent = summary.upcomingEvents;
            if (summary.eventList && summary.eventList.length > 0) {
                summary.eventList.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'flex items-center justify-between text-sm border-b border-purple-200 pb-1';
                    eventDiv.innerHTML = `<span class="font-semibold text-gray-700">${event.name}</span><span class="text-xs text-gray-600">${event.date}</span>`;
                    eventListContainer.appendChild(eventDiv);
                });
            } else {
                eventListContainer.innerHTML = `<p class="text-xs text-gray-600">Tidak ada acara dalam waktu dekat.</p>`;
            }
            animateChart('paymentChart', summary);
        }

        function renderTeamCards(teams) {
            const teamGrid = document.getElementById('teamGrid');
            teamGrid.innerHTML = '';

            if (Object.keys(teams).length === 0) {
                teamGrid.innerHTML = `<p class="text-gray-600 col-span-full">Belum ada data tim di spreadsheet 'Tugas_Tim'.</p>`;
                return;
            }

            for (const teamName in teams) {
                const team = teams[teamName];
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md flex flex-col';
                
                const renderList = (title, items, type, color) => {
                    let listHtml = `<div class="p-4"><h4 class="font-semibold text-sm ${color} mb-2">${title} (${items.length})</h4><ul class="space-y-1.5 text-sm max-h-32 overflow-y-auto pr-2 task-list">`;
                    if (items.length === 0) {
                        listHtml += `<li class="text-gray-400 italic text-xs">Tidak ada tugas</li>`;
                    } else {
                        items.forEach(item => {
                            if (type === 'selesai' && item.link) {
                                listHtml += `<li><a href="${item.link}" target="_blank" class="text-blue-600 hover:underline flex items-start gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg><span>${item.deskripsi}</span></a></li>`;
                            } else if (type === 'inProgress' && item.deadline) {
                                listHtml += `<li class="flex justify-between items-start gap-2"><span>${item.deskripsi}</span> <span class="text-xs font-medium text-red-500 bg-red-100 px-2 py-0.5 rounded-full flex-shrink-0">${item.deadline}</span></li>`;
                            } else {
                                listHtml += `<li>${item.deskripsi}</li>`;
                            }
                        });
                    }
                    listHtml += `</ul></div>`;
                    return listHtml;
                };

                const renderKomentar = (komentar) => {
                    let komentarHtml = `<div class="p-4 border-t"><h4 class="font-semibold text-sm text-gray-700 mb-2">Komentar Pimpinan</h4><div class="space-y-2 max-h-28 overflow-y-auto pr-2 task-list">`;
                    if (komentar.length > 0) {
                        komentar.slice().reverse().forEach(k => {
                            komentarHtml += `<div class="bg-blue-50 p-2 rounded-md text-xs"><p class="text-gray-800">${k.teks}</p><p class="text-right text-gray-500 mt-1">${k.timestamp}</p></div>`;
                        });
                    } else {
                        komentarHtml += `<p class="text-gray-400 italic text-xs">Belum ada komentar.</p>`;
                    }
                    komentarHtml += `</div></div>`;
                    return komentarHtml;
                };

                card.innerHTML = `
                    <div class="p-4 border-b"><h3 class="font-bold text-lg text-gray-800">${teamName}</h3></div>
                    ${renderList('To Do List', team.todo, 'todo', 'text-gray-700')}
                    ${renderList('In Progress', team.inProgress, 'inProgress', 'text-yellow-600')}
                    ${renderList('Tugas Selesai', team.selesai, 'selesai', 'text-green-600')}
                    ${renderKomentar(team.komentar)}
                    <div class="border-t p-4 mt-auto bg-gray-50 rounded-b-lg">
                        <div class="flex gap-2">
                            <input type="text" id="comment-input-${teamName.replace(/\s+/g, '-')}" class="flex-grow border border-gray-300 rounded-md px-2 py-1 text-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Tulis komentar...">
                            <button onclick="postComment('${teamName}')" class="bg-blue-600 text-white px-3 py-1 rounded-md text-sm font-semibold hover:bg-blue-700 transition-colors">Kirim</button>
                        </div>
                    </div>
                `;
                teamGrid.appendChild(card);
            }
        }

        async function postComment(teamName) {
            const inputId = `comment-input-${teamName.replace(/\s+/g, '-')}`;
            const inputElement = document.getElementById(inputId);
            const commentText = inputElement.value.trim();
            if (!commentText) return showNotification('Komentar tidak boleh kosong', 'error');

            const payload = { action: 'addComment', tim: teamName, komentar: commentText };
            try {
                showNotification('Mengirim komentar...', 'info');
                await fetch(googleSheetsConfig.webAppUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                showNotification('Komentar berhasil dikirim!', 'success');
                inputElement.value = '';
                setTimeout(() => fetchDashboardData(true), 1500);
            } catch (error) {
                console.error('Error posting comment:', error);
                showNotification('Gagal mengirim komentar', 'error');
            }
        }

        function animateChart(chartId, summary) {
            if (chartId === 'paymentChart') {
                const circle = document.getElementById('paymentCircle');
                const percentage = summary.paidPercentage || 0;
                const circumference = 2 * Math.PI * 50; // 2 * pi * r
                const offset = circumference - (percentage / 100) * circumference;
                circle.style.strokeDashoffset = offset;
            }
        }

        document.addEventListener('DOMContentLoaded', fetchDashboardData);
    </script>
</body>
</html>
