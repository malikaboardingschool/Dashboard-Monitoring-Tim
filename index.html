<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Monitoring Tim - Sekolah Boarding Internasional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .notification { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .skeleton-card { background-color: #f1f5f9; border-radius: 0.75rem; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .task-list::-webkit-scrollbar { width: 5px; }
        .task-list::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .task-list::-webkit-scrollbar-thumb { background: #60a5fa; /* blue-400 */ border-radius: 10px; }
        .task-list::-webkit-scrollbar-thumb:hover { background: #3b82f6; /* blue-500 */ }
        .chart-card { transition: all 0.3s ease-in-out; }
        .chart-card:hover { transform: translateY(-10px); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15); }
        .tab-content { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Style for active tab */
        .tab-active {
            border-color: #3b82f6; /* blue-500 */
            color: #2563eb; /* blue-600 */
            font-weight: 600;
        }
    </style>
</head>
<body class="bg-white relative overflow-x-hidden">
    <!-- Decorative Blobs -->
    <div class="absolute top-0 right-0 -mr-48 -mt-48 w-96 h-96 bg-blue-300 rounded-full opacity-30 mix-blend-multiply filter blur-3xl animate-pulse"></div>
    <div class="absolute bottom-0 left-0 -ml-48 -mb-48 w-80 h-80 bg-yellow-300 rounded-full opacity-30 mix-blend-multiply filter blur-3xl animate-pulse animation-delay-4000"></div>

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-20">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 py-4">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="flex-1">
                    <h1 class="text-xl sm:text-2xl lg:text-3xl font-extrabold text-blue-600">MALIKA BOARDING SCHOOL</h1>
                    <p class="text-sm sm:text-base text-gray-500 mt-1">Dashboard Monitoring Tim</p>
                </div>
                 <div class="flex items-center gap-3">
                    <div id="sheetsStatus" class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></div>
                    <span class="text-xs sm:text-sm text-gray-600" id="sheetsStatusText">Menghubungkan...</span>
                    <button onclick="fetchDashboardData(true)" class="bg-blue-50 hover:bg-blue-100 text-blue-600 p-2 rounded-full transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Dashboard -->
    <main class="max-w-screen-2xl mx-auto px-4 sm:px-6 py-6 sm:py-8 relative z-10">
        <!-- KARTU STATISTIK -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-8">
            <!-- Program List -->
            <div class="chart-card bg-emerald-600 rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-sm font-medium text-emerald-200">Program List</p>
                        <p class="text-4xl font-bold text-white" id="approvedPrograms"><span class="skeleton-card w-12 h-8 inline-block"></span></p>
                    </div>
                </div>
                <div class="space-y-2 text-sm" id="programListContainer"><div class="skeleton-card w-full h-5"></div><div class="skeleton-card w-full h-5"></div><div class="skeleton-card w-full h-5"></div></div>
            </div>
            <!-- Pembayaran SPP -->
            <div class="chart-card bg-white border border-gray-200 rounded-2xl shadow-lg p-6">
                <p class="text-base font-medium text-gray-700 mb-2">Pembayaran SPP</p>
                <div class="flex items-center justify-between gap-4">
                    <div class="relative w-32 h-32 flex-shrink-0">
                        <svg class="w-full h-full transform -rotate-90"><circle class="text-blue-100" stroke-width="12" stroke="currentColor" fill="transparent" r="50" cx="50%" cy="50%"/><circle id="paymentCircle" class="text-blue-500" stroke-width="12" stroke-linecap="round" stroke="currentColor" fill="transparent" r="50" cx="50%" cy="50%" style="stroke-dasharray: 314; stroke-dashoffset: 314; transition: stroke-dashoffset 1s ease-out;"/></svg>
                        <div class="absolute inset-0 flex items-center justify-center"><span id="paidPercentageText" class="text-3xl font-bold text-blue-600">...</span></div>
                    </div>
                    <div class="flex-grow">
                        <p class="text-4xl font-bold text-gray-800" id="paidStudents"><span class="skeleton-card w-20 h-10 inline-block"></span></p>
                        <p class="text-sm text-gray-500" id="totalStudentsText">dari ... santri</p>
                        <div class="space-y-1 mt-4 border-t border-gray-200 pt-2">
                            <div class="flex justify-between text-sm"><span class="text-gray-600">Lunas</span><span class="font-medium text-green-600" id="paidCount">...</span></div>
                            <div class="flex justify-between text-sm"><span class="text-gray-600">Belum Bayar</span><span class="font-medium text-red-600" id="unpaidCount">...</span></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Upcoming Events -->
            <div class="chart-card bg-slate-100 border border-gray-200 rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-base font-medium text-gray-700">Upcoming Events</p>
                        <p class="text-4xl font-bold text-blue-600" id="upcomingEvents"><span class="skeleton-card w-12 h-10 inline-block"></span></p>
                        <p class="text-sm text-gray-500">bulan ini</p>
                    </div>
                </div>
                <div class="space-y-2" id="eventListContainer"><div class="skeleton-card w-full h-5"></div><div class="skeleton-card w-full h-5"></div></div>
            </div>
        </div>
        
        <hr class="my-8 border-gray-200">

        <h2 class="text-2xl font-bold text-gray-800 mb-6">Monitoring Tugas Tim</h2>
        <div id="teamMonitoringTabs">
            <!-- Tabs akan di-generate oleh JavaScript -->
            <div class="skeleton-card w-full h-12 mb-4"></div>
            <div class="skeleton-card w-full h-[500px]"></div>
        </div>
    </main>

    <!-- Notification -->
    <div id="notification" class="fixed top-20 right-4 w-auto bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden notification z-50">
        <span id="notificationText"></span>
    </div>

    <script>
        const googleSheetsConfig = {
            webAppUrl: 'https://script.google.com/macros/s/AKfycbwR82NaJWlBaRC3_92aKX_Dc_4-yFGQE653-AHy4FBIkeyinvKsht5EGxagJWZA-rUMlA/exec',
        };

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            notificationText.textContent = message;
            notification.className = `fixed top-20 right-4 w-auto text-white px-6 py-3 rounded-lg shadow-lg notification z-50 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
            notification.classList.remove('hidden');
            setTimeout(() => notification.classList.add('hidden'), 3000);
        }

        async function fetchDashboardData(forceRefresh = false) {
            const statusIndicator = document.getElementById('sheetsStatus');
            const statusText = document.getElementById('sheetsStatusText');
            statusIndicator.className = 'w-3 h-3 bg-yellow-500 rounded-full animate-pulse';
            statusText.textContent = 'Memuat Data...';

            let url = googleSheetsConfig.webAppUrl;
            if (forceRefresh) {
                url += `?cache_bust=${new Date().getTime()}`;
            }

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                statusIndicator.className = 'w-3 h-3 bg-green-500 rounded-full';
                statusText.textContent = 'Terhubung';
                
                renderSummaryCards(data.summary);
                renderTeamTabs(data.teams, data.teamOrder);
                if(forceRefresh) showNotification('Data berhasil dimuat ulang!', 'success');

            } catch (error) {
                console.error("Error fetching data:", error);
                statusIndicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                statusText.textContent = 'Gagal Terhubung';
                document.getElementById('teamMonitoringTabs').innerHTML = `<p class="text-red-600 col-span-full">Gagal memuat data tim. Pastikan URL Apps Script benar dan sudah di-deploy ulang.</p>`;
            }
        }

        function renderSummaryCards(summary) {
            document.getElementById('approvedPrograms').textContent = summary.approvedPrograms;
            const programListContainer = document.getElementById('programListContainer');
            programListContainer.innerHTML = '';
            if (summary.programList && summary.programList.length > 0) {
                 summary.programList.forEach(prog => {
                    const progDiv = document.createElement('div');
                    progDiv.className = 'text-xs border-b border-emerald-500 pb-2 mb-2';
                    progDiv.innerHTML = `<div class="flex justify-between items-center"><p class="font-bold text-white text-sm">${prog.nama}</p><span class="font-medium text-emerald-800 bg-emerald-200 px-2 py-0.5 rounded-full">${prog.status}</span></div><div class="flex justify-between text-emerald-100 mt-1"><span>${prog.kategori}</span><span>Oleh: ${prog.tim}</span></div>`;
                    programListContainer.appendChild(progDiv);
                });
            } else {
                programListContainer.innerHTML = `<p class="text-xs text-emerald-100 italic">Belum ada program yang disetujui.</p>`;
            }

            document.getElementById('paidStudents').textContent = summary.paidStudents;
            document.getElementById('totalStudentsText').innerHTML = `dari ${summary.totalStudents} santri`;
            document.getElementById('paidPercentageText').textContent = `${summary.paidPercentage}%`;
            document.getElementById('paidCount').textContent = summary.paidStudents;
            document.getElementById('unpaidCount').textContent = summary.unpaidCount;
            
            const eventListContainer = document.getElementById('eventListContainer');
            eventListContainer.innerHTML = '';
            document.getElementById('upcomingEvents').textContent = summary.upcomingEvents;
            if (summary.eventList && summary.eventList.length > 0) {
                summary.eventList.forEach(event => {
                    const eventDiv = document.createElement('div');
                    eventDiv.className = 'flex items-center justify-between text-sm border-b border-gray-200 pb-1';
                    eventDiv.innerHTML = `<span class="font-semibold text-gray-700">${event.name}</span><span class="text-xs text-gray-600">${event.date}</span>`;
                    eventListContainer.appendChild(eventDiv);
                });
            } else {
                eventListContainer.innerHTML = `<p class="text-xs text-gray-600">Tidak ada acara dalam waktu dekat.</p>`;
            }
            animateChart('paymentChart', summary);
        }

        function renderTeamTabs(teams, teamOrder) {
            const container = document.getElementById('teamMonitoringTabs');
            container.innerHTML = '';

            const teamNamesToRender = teamOrder || Object.keys(teams);

            if (teamNamesToRender.length === 0) {
                container.innerHTML = `<p class="text-gray-600">Belum ada data tim di spreadsheet 'Tugas_Tim'.</p>`;
                return;
            }
            
            const mobileSelect = document.createElement('select');
            mobileSelect.id = 'team-select-mobile';
            mobileSelect.className = 'block sm:hidden w-full p-3 border border-gray-300 rounded-lg mb-4';
            
            const tabNav = document.createElement('div');
            tabNav.className = 'hidden sm:flex border-b border-gray-200 overflow-x-auto whitespace-nowrap mb-4';
            
            const tabContentContainer = document.createElement('div');
            
            let isFirstTab = true;
            for (const teamName of teamNamesToRender) {
                if (!teams[teamName]) continue;
                const team = teams[teamName];
                const teamId = teamName.replace(/\s+/g, '-');

                const option = document.createElement('option');
                option.value = `tab-${teamId}`;
                option.textContent = teamName;
                mobileSelect.appendChild(option);

                const tabButton = document.createElement('button');
                tabButton.textContent = teamName;
                tabButton.className = `py-2 px-4 text-sm font-medium border-b-2 transition-colors duration-300 ${isFirstTab ? 'tab-active' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`;
                tabButton.dataset.target = `tab-${teamId}`;
                tabNav.appendChild(tabButton);

                const tabContent = document.createElement('div');
                tabContent.id = `tab-${teamId}`;
                tabContent.className = `tab-content bg-white rounded-lg shadow-md ${isFirstTab ? '' : 'hidden'}`;
                
                const renderList = (title, items, type, color) => {
                    let listHtml = `<div class="p-4"><h4 class="font-semibold text-sm ${color} mb-2">${title} (${items.length})</h4><ul class="space-y-1.5 text-sm max-h-32 overflow-y-auto pr-2 task-list">`;
                    if (items.length === 0) { listHtml += `<li class="text-gray-400 italic text-xs">Tidak ada tugas</li>`; } else {
                        items.forEach(item => {
                            if (type === 'selesai' && item.link) { listHtml += `<li><a href="${item.link}" target="_blank" class="text-blue-600 hover:underline flex items-start gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg><span>${item.deskripsi}</span></a></li>`;
                            } else if (type === 'inProgress' && item.deadline) { listHtml += `<li class="flex justify-between items-start gap-2"><span>${item.deskripsi}</span> <span class="text-xs font-medium text-red-500 bg-red-100 px-2 py-0.5 rounded-full flex-shrink-0">${item.deadline}</span></li>`;
                            } else { listHtml += `<li>${item.deskripsi}</li>`; }
                        });
                    }
                    listHtml += `</ul></div>`;
                    return listHtml;
                };

                const renderKomentar = (komentar) => {
                    let komentarHtml = `<div class="p-4 border-t"><h4 class="font-semibold text-sm text-gray-700 mb-2">Komentar Pimpinan</h4><div class="space-y-2 max-h-28 overflow-y-auto pr-2 task-list">`;
                    if (komentar.length > 0) {
                        komentar.slice().reverse().forEach(k => {
                            komentarHtml += `<div class="bg-blue-50 p-2 rounded-md text-xs"><p class="text-gray-800">${k.teks}</p><p class="text-right text-gray-500 mt-1">${k.timestamp}</p></div>`;
                        });
                    } else { komentarHtml += `<p class="text-gray-400 italic text-xs">Belum ada komentar.</p>`; }
                    komentarHtml += `</div></div>`;
                    return komentarHtml;
                };

                tabContent.innerHTML = `
                    ${renderList('Tugas Hari Ini', team.todo, 'todo', 'text-gray-700')}
                    ${renderList('Masih Proses Penyelesaian', team.inProgress, 'inProgress', 'text-yellow-600')}
                    ${renderList('Tugas Selesai', team.selesai, 'selesai', 'text-green-600')}
                    ${renderKomentar(team.komentar)}
                    <div class="border-t p-4 mt-auto bg-gray-50 rounded-b-lg">
                        <div class="flex gap-2">
                            <input type="text" id="comment-input-${teamId}" class="flex-grow border border-gray-300 rounded-md px-2 py-1 text-sm focus:ring-2 focus:ring-yellow-500 focus:border-transparent" placeholder="Tulis komentar...">
                            <button onclick="postComment('${teamName}')" class="bg-yellow-400 text-yellow-900 px-3 py-1 rounded-md text-sm font-semibold hover:bg-yellow-500 transition-colors">Kirim</button>
                        </div>
                    </div>
                `;
                tabContentContainer.appendChild(tabContent);
                isFirstTab = false;
            }

            container.appendChild(mobileSelect);
            container.appendChild(tabNav);
            container.appendChild(tabContentContainer);

            const switchTab = (targetId) => {
                tabContentContainer.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));
                document.getElementById(targetId).classList.remove('hidden');
            };

            tabNav.addEventListener('click', (e) => {
                if (e.target.tagName === 'BUTTON') {
                    tabNav.querySelectorAll('button').forEach(btn => btn.className = 'py-2 px-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300');
                    e.target.className = 'py-2 px-4 text-sm font-medium border-b-2 transition-colors duration-300 tab-active';
                    switchTab(e.target.dataset.target);
                }
            });

            mobileSelect.addEventListener('change', (e) => {
                switchTab(e.target.value);
            });
        }

        async function postComment(teamName) {
            const teamId = teamName.replace(/\s+/g, '-');
            const inputElement = document.getElementById(`comment-input-${teamId}`);
            const commentText = inputElement.value.trim();
            if (!commentText) return showNotification('Komentar tidak boleh kosong', 'error');

            const payload = { action: 'addComment', tim: teamName, komentar: commentText };
            try {
                showNotification('Mengirim komentar...', 'info');
                await fetch(googleSheetsConfig.webAppUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                showNotification('Komentar berhasil dikirim!', 'success');
                inputElement.value = '';
                setTimeout(() => fetchDashboardData(true), 1500);
            } catch (error) {
                console.error('Error posting comment:', error);
                showNotification('Gagal mengirim komentar', 'error');
            }
        }

        function animateChart(chartId, summary) {
            if (chartId === 'paymentChart') {
                const circle = document.getElementById('paymentCircle');
                const percentage = summary.paidPercentage || 0;
                const circumference = 2 * Math.PI * 50; // 2 * pi * r
                const offset = circumference - (percentage / 100) * circumference;
                circle.style.strokeDashoffset = offset;
            }
        }

        document.addEventListener('DOMContentLoaded', fetchDashboardData);
    </script>
</body>
</html>
