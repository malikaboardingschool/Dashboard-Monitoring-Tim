<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Monitoring Tim - Sekolah Boarding Internasional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .notification { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .skeleton-card { background-color: #f1f5f9; border-radius: 0.75rem; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .chart-card { transition: all 0.3s ease-in-out; }
        .chart-card:hover { transform: translateY(-10px); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15); }
    </style>
</head>
<body class="bg-slate-50 relative overflow-x-hidden">
    <!-- Decorative Blobs -->
    <div class="absolute top-0 right-0 -mr-48 -mt-48 w-96 h-96 bg-blue-300 rounded-full opacity-20 mix-blend-multiply filter blur-3xl animate-pulse"></div>
    <div class="absolute bottom-0 left-0 -ml-48 -mb-48 w-80 h-80 bg-yellow-300 rounded-full opacity-20 mix-blend-multiply filter blur-3xl animate-pulse animation-delay-4000"></div>

    <!-- Header -->
    <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-20 border-b border-gray-200">
        <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 py-4">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <div class="flex-1">
                    <h1 class="text-xl sm:text-2xl lg:text-3xl font-extrabold text-blue-600">MALIKA BOARDING SCHOOL</h1>
                    <p class="text-sm sm:text-base text-gray-500 mt-1">Dashboard Monitoring Tim</p>
                </div>
                <!-- FITUR TANGGAL BARU -->
                <div class="text-right hidden sm:block">
                    <p id="gregorianDate" class="font-semibold text-gray-700">Memuat tanggal...</p>
                    <p id="hijriDate" class="text-sm text-gray-500" dir="rtl"></p>
                </div>
                 <div class="flex items-center gap-3">
                    <div id="sheetsStatus" class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></div>
                    <span class="text-xs sm:text-sm text-gray-600" id="sheetsStatusText">Menghubungkan...</span>
                    <button onclick="fetchDashboardData(true)" class="bg-blue-50 hover:bg-blue-100 text-blue-600 p-2 rounded-full transition-colors" title="Refresh Data">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Dashboard -->
    <main class="max-w-screen-2xl mx-auto px-4 sm:px-6 py-6 sm:py-8 relative z-10">
        <!-- KARTU STATISTIK -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-8">
             <!-- Kartu Statistik -->
            <div class="chart-card bg-gradient-to-br from-sky-500 to-indigo-600 rounded-2xl shadow-lg p-6">
                 <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-sm font-medium text-sky-100">Feedback & Masukan</p>
                        <p class="text-4xl font-bold text-white" id="newFeedbackCount"><span class="skeleton-card bg-sky-400/50 w-12 h-8 inline-block"></span></p>
                    </div>
                </div>
                <div id="feedbackListContainer" class="space-y-2"><div class="skeleton-card bg-sky-400/50 w-full h-10"></div></div>
            </div>
            <div class="chart-card bg-slate-800 rounded-2xl shadow-lg p-6">
                <p class="text-base font-medium text-slate-300 mb-2">Pembayaran SPP</p>
                 <div class="flex items-center justify-between gap-4">
                    <div class="relative w-32 h-32 flex-shrink-0">
                        <svg class="w-full h-full transform -rotate-90"><circle class="text-slate-600" stroke-width="12" stroke="currentColor" fill="transparent" r="50" cx="50%" cy="50%"/><circle id="paymentCircle" class="text-cyan-400" stroke-width="12" stroke-linecap="round" stroke="currentColor" fill="transparent" r="50" cx="50%" cy="50%" style="stroke-dasharray: 314; stroke-dashoffset: 314; transition: stroke-dashoffset 1s ease-out;"/></svg>
                        <div class="absolute inset-0 flex items-center justify-center"><span id="paidPercentageText" class="text-3xl font-bold text-white">...</span></div>
                    </div>
                    <div class="flex-grow">
                        <p class="text-4xl font-bold text-white" id="paidStudents"><span class="skeleton-card bg-slate-600 w-20 h-10 inline-block"></span></p>
                        <p class="text-sm text-slate-400" id="totalStudentsText">dari ... santri</p>
                        <!-- BAGIAN DETAIL PEMBAYARAN BARU -->
                        <div class="space-y-1 mt-4 border-t border-slate-700 pt-2">
                            <div class="flex justify-between text-sm"><span class="text-slate-400">Lunas Bulan Ini</span><span class="font-medium text-green-400" id="paidCount">...</span></div>
                            <div class="flex justify-between text-sm"><span class="text-slate-400">Belum Lunas Bulan Ini</span><span class="font-medium text-red-400" id="unpaidCount">...</span></div>
                            <div class="flex justify-between text-sm mt-2 pt-2 border-t border-slate-700"><span class="text-slate-400">Tunggakan Bulan Lalu</span><span class="font-medium text-yellow-400" id="arrearsLastMonth">...</span></div>
                        </div>
                    </div>
                </div>
            </div>
             <div class="chart-card bg-gradient-to-br from-amber-400 to-orange-500 rounded-2xl shadow-lg p-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <p class="text-base font-medium text-amber-100">Event Bulan Ini</p>
                        <p class="text-4xl font-bold text-white" id="upcomingEvents"><span class="skeleton-card bg-amber-300/50 w-12 h-10 inline-block"></span></p>
                    </div>
                </div>
                 <div id="eventListContainer" class="space-y-2"><div class="skeleton-card bg-amber-300/50 w-full h-10"></div></div>
            </div>
        </div>
        
        <hr class="my-8 border-gray-200">

        <h2 class="text-2xl font-bold text-gray-800 mb-6">Monitoring Tim</h2>
        <div id="teamMonitoring">
            <!-- Tampilan Monitoring Tim akan di-generate oleh JavaScript -->
             <div class="skeleton-card w-full h-[300px]"></div>
        </div>
    </main>

    <!-- Notification -->
    <div id="notification" class="fixed top-20 right-4 w-auto bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden notification z-50">
        <span id="notificationText"></span>
    </div>

    <script>
        const googleSheetsConfig = {
            webAppUrl: 'https://script.google.com/macros/s/AKfycbw1Za6at-Zvj5IrqUUuCFJUl6OVWvE0-utfWRhdO9AFXCM3yVbicVnorJqQrfnq-TFkMQ/exec',
        };

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `fixed top-20 right-4 w-auto text-white px-6 py-3 rounded-lg shadow-lg notification z-50 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
            notification.classList.remove('hidden');
            setTimeout(() => notification.classList.add('hidden'), 3000);
        }

        function displayCurrentDates() {
            const today = new Date();
            document.getElementById('gregorianDate').textContent = today.toLocaleDateString('id-ID', {
                weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
            });
            try {
                const hijriFormatter = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura', {
                    day: 'numeric', month: 'long', year: 'numeric'
                });
                document.getElementById('hijriDate').textContent = hijriFormatter.format(today);
            } catch (e) {
                console.error("Gagal memuat tanggal Hijriah:", e);
                document.getElementById('hijriDate').textContent = 'Gagal memuat tanggal Hijriah';
            }
        }

        function renderSummaryCards(summary) {
            document.getElementById('newFeedbackCount').textContent = summary.newFeedbackCount || '0';
            const feedbackContainer = document.getElementById('feedbackListContainer');
            feedbackContainer.innerHTML = ''; 
             if (!summary.feedbackList || summary.feedbackList.length === 0) {
                feedbackContainer.innerHTML = `<p class="text-sm text-sky-200 italic">Belum ada feedback baru.</p>`;
            } else {
                summary.feedbackList.forEach(fb => {
                    const div = document.createElement('div');
                    div.className = 'text-xs border-b border-sky-400/50 pb-2';
                    div.innerHTML = `<p class="font-bold text-white">${fb.isi}</p><p class="text-sky-200 mt-1">${fb.kategori} - ${fb.penerima}</p>`;
                    feedbackContainer.appendChild(div);
                });
            }

            // --- PEMBARUAN KARTU SPP ---
            document.getElementById('paidStudents').textContent = summary.paidStudents || '0';
            document.getElementById('totalStudentsText').textContent = `dari ${summary.totalStudents || 0} santri`;
            document.getElementById('paidPercentageText').textContent = `${summary.paidPercentage || 0}%`;
            document.getElementById('paidCount').textContent = summary.paidStudents || '0';
            document.getElementById('unpaidCount').textContent = summary.unpaidCount || '0';
            document.getElementById('arrearsLastMonth').textContent = summary.arrearsLastMonth || '0'; // Data baru

            const paymentCircle = document.getElementById('paymentCircle');
            const circumference = 2 * Math.PI * 50;
            const offset = circumference - ((summary.paidPercentage || 0) / 100) * circumference;
            paymentCircle.style.strokeDashoffset = offset;
            
            document.getElementById('upcomingEvents').textContent = summary.upcomingEvents || '0';
            const eventsContainer = document.getElementById('eventListContainer');
            eventsContainer.innerHTML = '';
            if (!summary.eventList || summary.eventList.length === 0) {
                 eventsContainer.innerHTML = `<p class="text-sm text-amber-100 italic">Tidak ada acara bulan ini.</p>`;
            } else {
                 summary.eventList.forEach(event => {
                    const div = document.createElement('div');
                    div.className = 'text-sm flex justify-between items-center border-b border-amber-300/50 pb-1';
                    div.innerHTML = `<span class="font-semibold text-white">${event.name}</span><span class="text-amber-100 text-xs">${event.date}</span>`;
                    eventsContainer.appendChild(div);
                });
            }
        }

        function renderTeamMonitoring(teams, teamOrder) {
            const container = document.getElementById('teamMonitoring');
            if (!teams || Object.keys(teams).length === 0) {
                container.innerHTML = `<p class="text-gray-500">Belum ada data aktivitas tim untuk hari ini.</p>`;
                return;
            }

            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
                    ${teamOrder.map(teamName => {
                        const team = teams[teamName];
                        
                        const renderList = (items, isCompletedList = false) => {
                            if (!items || items.length === 0) return '<p class="text-sm text-gray-400 italic">Tidak ada</p>';
                            return `<ul class="list-disc list-inside space-y-2">${items.map(item => {
                                if (isCompletedList && item.link) {
                                    return `<li><a href="${item.link}" target="_blank" class="text-sm text-blue-600 hover:underline">${item.deskripsi} 🔗</a></li>`;
                                }
                                return `<li class="text-sm text-gray-600">${isCompletedList ? item.deskripsi : item}</li>`;
                            }).join('')}</ul>`;
                        };

                        const renderKomentar = (komentar) => {
                             if (!komentar || komentar.length === 0) return '<p class="text-sm text-gray-400 italic">Belum ada komentar.</p>';
                             return `<div class="space-y-2">${komentar.slice(-3).reverse().map(k => `
                                <div class="text-xs bg-gray-100 p-2 rounded-md">
                                    <p class="text-gray-700">${k.teks}</p>
                                    <p class="text-right text-gray-400 mt-1">${k.dari} - ${k.timestamp}</p>
                                </div>`).join('')}
                             </div>`;
                        };

                        return `
                        <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                            <h3 class="font-bold text-lg text-blue-600 mb-4">${teamName}</h3>
                            <div class="space-y-4">
                                <div>
                                    <h4 class="font-semibold text-gray-700 mb-2">🎯 Target Minggu Ini</h4>
                                    ${renderList(team.weeklyTargets)}
                                </div>
                                <hr>
                                <div>
                                    <h4 class="font-semibold text-gray-700 mb-2">✅ Tugas Hari Ini</h4>
                                    ${renderList(team.dailyTasks)}
                                </div>
                                <hr>
                                <div>
                                    <h4 class="font-semibold text-green-600 mb-2">🎉 Tugas Selesai Minggu Ini</h4>
                                    ${renderList(team.completedTasks, true)}
                                </div>
                                <hr>
                                <div>
                                    <h4 class="font-semibold text-gray-700 mb-2">💬 Komentar Pimpinan</h4>
                                    ${renderKomentar(team.komentar)}
                                    <div class="mt-3">
                                        <textarea id="comment-${teamName.replace(/\s+/g, '-')}" class="w-full text-sm border-gray-300 rounded-md shadow-sm" rows="2" placeholder="Tulis komentar..."></textarea>
                                        <button onclick="postComment('${teamName}')" class="mt-2 bg-blue-500 text-white px-3 py-1 text-xs font-semibold rounded-md hover:bg-blue-600">Kirim</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        async function postComment(teamName) {
            const textareaId = `comment-${teamName.replace(/\s+/g, '-')}`;
            const textarea = document.getElementById(textareaId);
            const komentar = textarea.value.trim();

            if (!komentar) {
                showNotification('Komentar tidak boleh kosong', 'error');
                return;
            }

            try {
                await fetch(googleSheetsConfig.webAppUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ action: 'addComment', tim: teamName, komentar: komentar })
                });
                showNotification('Komentar berhasil dikirim!', 'success');
                textarea.value = '';
                setTimeout(() => fetchDashboardData(true), 2000);
            } catch (error) {
                showNotification('Gagal mengirim komentar', 'error');
            }
        }
        
        async function fetchDashboardData(forceRefresh = false) {
             const statusIndicator = document.getElementById('sheetsStatus');
             const statusText = document.getElementById('sheetsStatusText');
             statusIndicator.className = 'w-3 h-3 bg-yellow-500 rounded-full animate-pulse';
             statusText.textContent = 'Memuat Data...';
             let url = googleSheetsConfig.webAppUrl;
             if (forceRefresh) { url += `?cache_bust=${new Date().getTime()}`; }
             try {
                 const response = await fetch(url);
                 if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                 const data = await response.json();
                 if (data.error) throw new Error(data.error);
                 statusIndicator.className = 'w-3 h-3 bg-green-500 rounded-full';
                 statusText.textContent = 'Terhubung';
                 renderSummaryCards(data.summary);
                 renderTeamMonitoring(data.teams, data.teamOrder);
                 if(forceRefresh) showNotification('Data berhasil dimuat ulang!', 'success');
             } catch (error) {
                 console.error("Error fetching data:", error);
                 statusIndicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                 statusText.textContent = 'Gagal Terhubung';
                 // --- PERBAIKAN PESAN ERROR ---
                 const errorMessage = `
                    <div class="text-red-600 bg-red-50 p-4 rounded-lg col-span-full">
                        <p class="font-bold">Gagal memuat data tim.</p>
                        <p class="text-sm mt-2">Penyebab paling umum adalah kesalahan pada pengaturan Google Apps Script. Mohon pastikan:</p>
                        <ul class="list-disc list-inside text-sm mt-1 pl-2">
                            <li>URL Apps Script yang dimasukkan sudah benar.</li>
                            <li>Saat melakukan Deploy, opsi "Who has access" diatur ke "Anyone".</li>
                        </ul>
                    </div>
                 `;
                 document.getElementById('teamMonitoring').innerHTML = errorMessage;
             }
         }

        document.addEventListener('DOMContentLoaded', () => {
            displayCurrentDates(); 
            fetchDashboardData();
        });
    </script>
</body>
</html>

