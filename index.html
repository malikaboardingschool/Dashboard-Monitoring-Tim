<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Monitoring Tim - Sekolah Boarding Internasional</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .notification { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .skeleton-card { background-color: #f1f5f9; border-radius: 0.75rem; animation: pulse 1.s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .chart-card { transition: all 0.3s ease-in-out; }
        .chart-card:hover { transform: translateY(-10px); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15); }
        .sidebar-item.active { background-color: #eff6ff; color: #2563eb; font-weight: 600; }
        .sidebar::-webkit-scrollbar { width: 4px; }
        .sidebar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 10px; }
    </style>
</head>
<body class="bg-slate-50 relative overflow-x-hidden">
    <!-- Decorative Blobs -->
    <div class="absolute top-0 right-0 -mr-48 -mt-48 w-96 h-96 bg-blue-300 rounded-full opacity-20 mix-blend-multiply filter blur-3xl animate-pulse"></div>
    <div class="absolute bottom-0 left-0 -ml-48 -mb-48 w-80 h-80 bg-purple-300 rounded-full opacity-20 mix-blend-multiply filter blur-3xl animate-pulse animation-delay-4000"></div>

    <!-- KONTEN APLIKASI UTAMA (SEMBUNYI SECARA DEFAULT) -->
    <div id="appContainer" class="hidden">
        <!-- Header -->
        <header class="bg-white/80 backdrop-blur-lg sticky top-0 z-20 border-b border-gray-200">
            <div class="max-w-screen-2xl mx-auto px-4 sm:px-6 py-4">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div class="flex items-center gap-3 sm:gap-4">
                        <img src="https://iili.io/FsLlXA7.png" alt="Logo Malika Boarding School" class="h-10 sm:h-12 w-auto">
                        <div>
                            <h1 class="text-lg sm:text-2xl lg:text-3xl font-extrabold text-[#020c91]">MALIKA BOARDING SCHOOL</h1>
                            <p class="text-xs sm:text-base text-gray-500 mt-1">Dashboard Monitoring Tim</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4 sm:gap-6">
                        <div class="text-right">
                            <p id="gregorianDate" class="text-xs sm:text-sm font-semibold text-gray-700">Memuat tanggal...</p>
                            <p id="hijriDate" class="text-xs sm:text-sm text-gray-500" dir="rtl"></p>
                        </div>
                         <div class="flex items-center gap-3">
                            <div id="sheetsStatus" class="w-3 h-3 bg-yellow-500 rounded-full animate-pulse"></div>
                            <span class="hidden sm:inline text-xs sm:text-sm text-gray-600" id="sheetsStatusText">Menghubungkan...</span>
                            <button onclick="fetchDashboardData(true)" class="bg-blue-50 hover:bg-blue-100 text-blue-600 p-2 rounded-full transition-colors" title="Refresh Data">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Dashboard -->
        <main class="max-w-screen-2xl mx-auto px-4 sm:px-6 py-6 sm:py-8 relative z-10">
            <!-- KARTU STATISTIK (URUTAN BARU) -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mb-8">
                <!-- 1. Event Bulan Ini (WARNA BARU) -->
                <div class="chart-card bg-gradient-to-br from-sky-500 to-indigo-600 rounded-2xl shadow-lg p-6 relative overflow-hidden">
                    <div class="absolute -top-4 -right-4 w-24 h-24 bg-white/10 rounded-full"></div>
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <p class="text-base font-medium text-sky-100">Event Bulan Ini</p>
                            <p class="text-4xl font-bold text-white" id="upcomingEvents"><span class="skeleton-card bg-sky-400/50 w-12 h-10 inline-block"></span></p>
                        </div>
                    </div>
                     <div id="eventListContainer" class="space-y-3"><div class="skeleton-card bg-sky-400/50 w-full h-12"></div></div>
                </div>

                <!-- 2. Pembayaran SPP -->
                <div class="chart-card bg-slate-800 rounded-2xl shadow-lg p-6">
                    <p class="text-base font-medium text-slate-300 mb-2">Pembayaran SPP</p>
                     <div class="flex items-center justify-between gap-4">
                        <div class="relative w-32 h-32 flex-shrink-0">
                            <svg class="w-full h-full transform -rotate-90"><circle class="text-slate-600" stroke-width="12" stroke="currentColor" fill="transparent" r="50" cx="50%" cy="50%"/><circle id="paymentCircle" class="text-cyan-400" stroke-width="12" stroke-linecap="round" stroke="currentColor" fill="transparent" r="50" cx="50%" cy="50%" style="stroke-dasharray: 314; stroke-dashoffset: 314; transition: stroke-dashoffset 1s ease-out;"/></svg>
                            <div class="absolute inset-0 flex items-center justify-center"><span id="paidPercentageText" class="text-3xl font-bold text-white">...</span></div>
                        </div>
                        <div class="flex-grow">
                            <p class="text-4xl font-bold text-white" id="paidStudents"><span class="skeleton-card bg-slate-600 w-20 h-10 inline-block"></span></p>
                            <p class="text-sm text-slate-400" id="totalStudentsText">dari ... santri</p>
                            <div class="space-y-1 mt-4 border-t border-slate-700 pt-2">
                                <div class="flex justify-between text-sm"><span class="text-slate-400">Lunas Bulan Ini</span><span class="font-medium text-green-400" id="paidCount">...</span></div>
                                <div class="flex justify-between text-sm"><span class="text-slate-400">Belum Lunas Bulan Ini</span><span class="font-medium text-red-400" id="unpaidCount">...</span></div>
                                <div class="flex justify-between text-sm mt-2 pt-2 border-t border-slate-700"><span class="text-slate-400">Tunggakan Bulan Lalu</span><span class="font-medium text-yellow-400" id="arrearsLastMonth">...</span></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. Feedback & Masukan (WARNA BARU) -->
                <div class="chart-card bg-gradient-to-br from-purple-500 to-pink-500 rounded-2xl shadow-lg p-6 relative overflow-hidden">
                    <div class="absolute -top-4 -right-4 w-24 h-24 bg-white/10 rounded-full"></div>
                    <div class="relative z-10">
                        <div class="flex items-start justify-between mb-4">
                            <div>
                                <p class="text-base font-medium text-purple-100">Feedback & Masukan</p>
                                <p class="text-5xl font-extrabold text-white mt-2" id="newFeedbackCount"><span class="skeleton-card bg-purple-400/50 w-16 h-12 inline-block"></span></p>
                            </div>
                            <div class="bg-white/20 p-3 rounded-xl">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
                                </svg>
                            </div>
                        </div>
                        <p class="text-sm text-purple-200 mb-4">Pesan baru yang perlu ditanggapi.</p>
                        <div id="feedbackListContainer" class="space-y-2"><div class="skeleton-card bg-purple-400/50 w-full h-10"></div></div>
                    </div>
                </div>
            </div>
            
            <hr class="my-8 border-gray-200">

            <h2 class="text-2xl font-bold text-gray-800 mb-6">Monitoring Tim</h2>
            <div id="teamMonitoring">
                 <div class="skeleton-card w-full h-96"></div>
            </div>
        </main>
    </div>

    <!-- LAYAR PASSWORD BARU -->
    <div id="passwordModal" class="fixed inset-0 bg-slate-100 z-50 flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div class="bg-white p-8 rounded-2xl shadow-xl text-center">
                <img src="https://iili.io/FsLlXA7.png" alt="Logo Malika Boarding School" class="h-16 w-auto mx-auto mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Akses Terbatas</h2>
                <p class="text-gray-500 mt-2 mb-6">Silakan masukkan kata sandi untuk melanjutkan.</p>
                <form id="passwordForm">
                    <input type="password" id="passwordInput" class="w-full px-4 py-3 border border-gray-300 rounded-lg text-center text-lg tracking-widest" placeholder="••••••••">
                    <p id="passwordError" class="text-red-500 text-sm mt-2 h-5"></p>
                    <button type="submit" class="w-full bg-[#020c91] text-white py-3 rounded-lg font-semibold mt-4 hover:bg-opacity-90 transition-colors">Masuk</button>
                </form>
            </div>
        </div>
    </div>


    <!-- Notification -->
    <div id="notification" class="fixed top-20 right-4 w-auto bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg hidden notification z-50">
        <span id="notificationText"></span>
    </div>

    <script>
        // --- KONFIGURASI & LOGIKA PASSWORD BARU ---
        const CORRECT_PASSWORD = '99'; // Anda bisa mengubah password di sini

        document.addEventListener('DOMContentLoaded', () => {
            const passwordForm = document.getElementById('passwordForm');
            const passwordInput = document.getElementById('passwordInput');
            const passwordError = document.getElementById('passwordError');
            const appContainer = document.getElementById('appContainer');
            const passwordModal = document.getElementById('passwordModal');

            if (sessionStorage.getItem('isAuthenticated') === 'true') {
                showApp();
            }

            passwordForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (passwordInput.value === CORRECT_PASSWORD) {
                    sessionStorage.setItem('isAuthenticated', 'true');
                    showApp();
                } else {
                    passwordError.textContent = 'Kata sandi salah. Silakan coba lagi.';
                    passwordInput.classList.add('border-red-500');
                    passwordInput.value = '';
                }
            });

            function showApp() {
                passwordModal.classList.add('hidden');
                appContainer.classList.remove('hidden');
                displayCurrentDates(); 
                fetchDashboardData();
            }
        });

        const googleSheetsConfig = {
            webAppUrl: 'https://script.google.com/macros/s/AKfycbw1Za6at-Zvj5IrqUUuCFJUl6OVWvE0-utfWRhdO9AFXCM3yVbicVnorJqQrfnq-TFkMQ/exec',
        };
        
        let fullTeamData = {}; 

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `fixed top-20 right-4 w-auto text-white px-6 py-3 rounded-lg shadow-lg notification z-50 ${type === 'error' ? 'bg-red-500' : 'bg-green-500'}`;
            notification.classList.remove('hidden');
            setTimeout(() => notification.classList.add('hidden'), 3000);
        }

        function displayCurrentDates() {
            const today = new Date();
            document.getElementById('gregorianDate').textContent = today.toLocaleDateString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
            try {
                const hijriFormatter = new Intl.DateTimeFormat('ar-SA-u-ca-islamic-umalqura', { day: 'numeric', month: 'long', year: 'numeric' });
                document.getElementById('hijriDate').textContent = hijriFormatter.format(today);
            } catch (e) { document.getElementById('hijriDate').textContent = 'Gagal memuat tanggal Hijriah'; }
        }

        function animateValue(element, start, end, duration) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                element.textContent = Math.floor(progress * (end - start) + start);
                if (progress < 1) {
                    window.requestAnimationFrame(step);
                }
            };
            window.requestAnimationFrame(step);
        }

        function renderSummaryCards(summary) {
            const feedbackCountEl = document.getElementById('newFeedbackCount');
            animateValue(feedbackCountEl, 0, summary.newFeedbackCount || 0, 1000);

            const feedbackContainer = document.getElementById('feedbackListContainer');
            feedbackContainer.innerHTML = ''; 
             if (!summary.feedbackList || summary.feedbackList.length === 0) {
                feedbackContainer.innerHTML = `<p class="text-sm text-purple-200 italic">Belum ada feedback baru.</p>`;
            } else {
                summary.feedbackList.forEach(fb => {
                    const div = document.createElement('div');
                    div.className = 'bg-purple-500/50 p-3 rounded-lg';
                    div.innerHTML = `
                        <div class="flex justify-between items-start">
                            <p class="text-sm text-white flex-1 pr-4">${fb.isi}</p>
                            <span class="text-xs font-medium text-yellow-800 bg-yellow-300 px-2 py-1 rounded-full whitespace-nowrap">${fb.status}</span>
                        </div>
                        <p class="text-xs text-purple-200 mt-2 text-right">Oleh: ${fb.penerima}</p>
                    `;
                    feedbackContainer.appendChild(div);
                });
            }

            document.getElementById('paidStudents').textContent = summary.paidStudents || '0';
            document.getElementById('totalStudentsText').textContent = `dari ${summary.totalStudents || 0} santri`;
            document.getElementById('paidPercentageText').textContent = `${summary.paidPercentage || 0}%`;
            document.getElementById('paidCount').textContent = summary.paidStudents || '0';
            document.getElementById('unpaidCount').textContent = summary.unpaidCount || '0';
            document.getElementById('arrearsLastMonth').textContent = summary.arrearsLastMonth || '0'; 

            const paymentCircle = document.getElementById('paymentCircle');
            const circumference = 2 * Math.PI * 50;
            const offset = circumference - ((summary.paidPercentage || 0) / 100) * circumference;
            paymentCircle.style.strokeDashoffset = offset;
            
            document.getElementById('upcomingEvents').textContent = summary.upcomingEvents || '0';
            const eventsContainer = document.getElementById('eventListContainer');
            eventsContainer.innerHTML = '';
            if (!summary.eventList || summary.eventList.length === 0) {
                 eventsContainer.innerHTML = `<p class="text-sm text-sky-200 italic">Tidak ada acara bulan ini.</p>`;
            } else {
                 summary.eventList.forEach(event => {
                    const dateParts = event.date.split(' ');
                    const day = dateParts[0];
                    const month = dateParts[1];
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-4';
                    div.innerHTML = `
                        <div class="flex-shrink-0 w-12 h-12 bg-white/20 rounded-xl flex flex-col items-center justify-center">
                            <span class="font-bold text-xl text-white">${day}</span>
                        </div>
                        <div>
                            <p class="font-semibold text-white">${event.name}</p>
                            <p class="text-xs text-sky-200">${month}</p>
                        </div>
                    `;
                    eventsContainer.appendChild(div);
                });
            }
        }

        function displayTeamContent(teamName) {
            const contentArea = document.getElementById('teamContent');
            const team = fullTeamData.teams[teamName];

            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.team === teamName) item.classList.add('active');
            });
            
            const mobileSelect = document.querySelector('#teamMonitoring select');
            if (mobileSelect) {
                mobileSelect.value = teamName;
            }

            if (!team) {
                contentArea.innerHTML = `<p>Data untuk tim ${teamName} tidak ditemukan.</p>`;
                return;
            }

            const renderList = (items, isCompletedList = false) => {
                if (!items || items.length === 0) return '<p class="text-sm text-gray-400 italic">Tidak ada</p>';
                return `<ul class="list-disc list-inside space-y-2">${items.map(item => {
                    if (isCompletedList && item.link) {
                        return `<li><a href="${item.link}" target="_blank" class="text-sm text-blue-600 hover:underline">${item.deskripsi} 🔗</a></li>`;
                    }
                    return `<li class="text-sm text-gray-600">${isCompletedList ? item.deskripsi : item}</li>`;
                }).join('')}</ul>`;
            };

            const renderKomentar = (komentar) => {
                 if (!komentar || komentar.length === 0) return '<p class="text-sm text-gray-400 italic">Belum ada komentar.</p>';
                 return `<div class="space-y-2">${komentar.slice(-3).reverse().map(k => `
                    <div class="text-xs bg-gray-100 p-2 rounded-md">
                        <p class="text-gray-700">${k.teks}</p>
                        <p class="text-right text-gray-400 mt-1">${k.dari} - ${k.timestamp}</p>
                    </div>`).join('')}
                 </div>`;
            };

            const contentHtml = `
                <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm">
                    <h3 class="font-bold text-2xl text-blue-600 mb-6">${teamName}</h3>
                    <div class="space-y-6">
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3 text-lg">🎯 Target Minggu Ini</h4>
                            ${renderList(team.weeklyTargets)}
                        </div>
                        <hr>
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3 text-lg">✅ Tugas Hari Ini</h4>
                            ${renderList(team.dailyTasks)}
                        </div>
                        <hr>
                        <div>
                            <h4 class="font-semibold text-green-600 mb-3 text-lg">🎉 Tugas Selesai Minggu Ini</h4>
                            ${renderList(team.completedTasks, true)}
                        </div>
                        <hr>
                        <div>
                            <h4 class="font-semibold text-gray-700 mb-3 text-lg">💬 Komentar Pimpinan</h4>
                            ${renderKomentar(team.komentar)}
                            <div class="mt-4">
                                <textarea id="comment-${teamName.replace(/\s+/g, '-')}" class="w-full text-sm border-gray-300 rounded-md shadow-sm" rows="2" placeholder="Tulis komentar untuk ${teamName}..."></textarea>
                                <button onclick="postComment('${teamName}')" class="mt-2 bg-blue-500 text-white px-4 py-2 text-sm font-semibold rounded-md hover:bg-blue-600">Kirim Komentar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            contentArea.innerHTML = contentHtml;
        }

        function renderTeamMonitoring(teams, teamOrder) {
            const container = document.getElementById('teamMonitoring');
            if (!teams || teamOrder.length === 0) {
                container.innerHTML = `<p class="text-gray-500">Belum ada data aktivitas tim untuk hari ini.</p>`;
                return;
            }

            container.innerHTML = `
                <div class="md:flex md:flex-row md:gap-8 md:items-start">
                    <div class="w-full md:w-1/4 lg:w-1/5">
                        <div class="md:hidden mb-4">
                            <select onchange="displayTeamContent(this.value)" class="w-full p-3 border-gray-300 rounded-xl shadow-sm text-lg font-semibold text-gray-700">
                                ${teamOrder.map(teamName => `<option value="${teamName}">${teamName}</option>`).join('')}
                            </select>
                        </div>
                        <div class="hidden md:block bg-white p-4 rounded-xl border border-gray-200 shadow-sm self-start h-auto md:max-h-[600px] overflow-y-auto sidebar">
                            <ul class="space-y-1">
                                ${teamOrder.map(teamName => `
                                    <li class="sidebar-item p-2 rounded-md cursor-pointer hover:bg-blue-50 text-gray-600" data-team="${teamName}" onclick="displayTeamContent('${teamName}')">
                                        ${teamName}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    </div>
                    <div class="w-full md:w-3/4 lg:w-4/5 mt-4 md:mt-0" id="teamContent">
                    </div>
                </div>
            `;
            
            if (teamOrder.length > 0) {
                setTimeout(() => {
                    displayTeamContent(teamOrder[0]);
                }, 0);
            }
        }

        async function postComment(teamName) {
            const textareaId = `comment-${teamName.replace(/\s+/g, '-')}`;
            const textarea = document.getElementById(textareaId);
            const komentar = textarea.value.trim();
            if (!komentar) { showNotification('Komentar tidak boleh kosong', 'error'); return; }

            try {
                await fetch(googleSheetsConfig.webAppUrl, {
                    method: 'POST', mode: 'no-cors',
                    body: JSON.stringify({ action: 'addComment', tim: teamName, komentar: komentar })
                });
                showNotification('Komentar berhasil dikirim!', 'success');
                textarea.value = '';
                setTimeout(() => fetchDashboardData(true), 2000);
            } catch (error) { showNotification('Gagal mengirim komentar', 'error'); }
        }
        
        async function fetchDashboardData(forceRefresh = false) {
             const statusIndicator = document.getElementById('sheetsStatus');
             const statusText = document.getElementById('sheetsStatusText');
             statusIndicator.className = 'w-3 h-3 bg-yellow-500 rounded-full animate-pulse';
             statusText.textContent = 'Memuat Data...';
             let url = googleSheetsConfig.webAppUrl;
             if (forceRefresh) { url += `?cache_bust=${new Date().getTime()}`; }
             try {
                 const response = await fetch(url);
                 if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                 const data = await response.json();
                 if (data.error) throw new Error(data.error);
                 
                 fullTeamData = data;
                 
                 statusIndicator.className = 'w-3 h-3 bg-green-500 rounded-full';
                 statusText.textContent = 'Terhubung';
                 renderSummaryCards(data.summary);
                 renderTeamMonitoring(data.teams, data.teamOrder);
                 if(forceRefresh) showNotification('Data berhasil dimuat ulang!', 'success');
             } catch (error) {
                 console.error("Error fetching data:", error);
                 statusIndicator.className = 'w-3 h-3 bg-red-500 rounded-full';
                 statusText.textContent = 'Gagal Terhubung';
                 const errorMessage = `
                    <div class="text-red-600 bg-red-50 p-4 rounded-lg col-span-full">
                        <p class="font-bold">Gagal memuat data tim.</p>
                        <p class="text-sm mt-2">Penyebab paling umum adalah kesalahan pada pengaturan Google Apps Script. Mohon pastikan:</p>
                        <ul class="list-disc list-inside text-sm mt-1 pl-2">
                            <li>URL Apps Script yang dimasukkan sudah benar.</li>
                            <li>Saat melakukan Deploy, opsi "Who has access" diatur ke "Anyone".</li>
                        </ul>
                    </div>
                 `;
                 document.getElementById('teamMonitoring').innerHTML = errorMessage;
             }
         }
    </script>
</body>
</html>

